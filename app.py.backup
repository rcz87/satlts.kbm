from flask import Flask, render_template, url_for, request, jsonify
from markupsafe import Markup
import markdown
import os
import psycopg2
from psycopg2.extras import RealDictCursor

app = Flask(__name__)
app.secret_key = os.environ.get('SESSION_SECRET', 'dev-secret-key-change-in-production')

def get_db_connection():
    conn = psycopg2.connect(os.environ['DATABASE_URL'])
    return conn

def load_markdown(filename):
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            content = f.read()
        
        html = markdown.markdown(
            content, 
            extensions=['tables', 'fenced_code', 'nl2br']
        )
        
        return Markup(html)
    except FileNotFoundError:
        return Markup(f'<p>File {filename} tidak ditemukan.</p>')
    except Exception as e:
        return Markup(f'<p>Error: {str(e)}</p>')

@app.route('/')
def index():
    content = load_markdown('content_home.md')
    return render_template('index.html', content=content, current_page='home')

@app.route('/5tahunan')
def tahunan():
    content = load_markdown('content_5tahunan.md')
    return render_template('index.html', content=content, current_page='5tahunan')

@app.route('/duplikat')
def duplikat():
    content = load_markdown('content_duplikat.md')
    return render_template('index.html', content=content, current_page='duplikat')

@app.route('/mutasi')
def mutasi():
    content = load_markdown('content_mutasi.md')
    return render_template('index.html', content=content, current_page='mutasi')

@app.route('/bbn')
def bbn():
    content = load_markdown('content_bbn.md')
    return render_template('index.html', content=content, current_page='bbn')

@app.route('/dasarhukum')
def dasarhukum():
    content = load_markdown('content_dasarhukum.md')
    return render_template('index.html', content=content, current_page='dasarhukum')

@app.route('/lihat-perpol')
def lihat_perpol():
    pdf_url = url_for('static', filename='documents/perpol-7-2021-regident.pdf')
    content = Markup(f'''
        <div class="pdf-container">
            <h2>ğŸ“œ Peraturan Kepolisian No. 7 Tahun 2021</h2>
            <h3>Tentang Registrasi dan Identifikasi Kendaraan Bermotor</h3>
            <p>Peraturan ini menjadi dasar hukum pelaksanaan layanan SAMSAT di seluruh Indonesia.</p>
            <hr>
            <div class="pdf-viewer">
                <iframe src="{pdf_url}" 
                        width="100%" 
                        height="800px" 
                        style="border: 1px solid #ddd; border-radius: 8px;">
                </iframe>
            </div>
            <p class="download-link">
                <a href="{pdf_url}" 
                   download 
                   style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #1e5aa8; color: white; text-decoration: none; border-radius: 5px;">
                   ğŸ“¥ Download PDF
                </a>
            </p>
        </div>
    ''')
    return render_template('index.html', content=content, current_page='dasarhukum')

@app.route('/lihat-uu-lalulintas')
def lihat_uu_lalulintas():
    pdf_url = url_for('static', filename='documents/uu-22-2009-lalulintas.pdf')
    content = Markup(f'''
        <div class="pdf-container">
            <h2>ğŸ“œ UU No. 22 Tahun 2009</h2>
            <h3>Tentang Lalu Lintas dan Angkutan Jalan</h3>
            <p>Undang-undang yang mengatur tentang lalu lintas dan angkutan jalan di Indonesia.</p>
            <hr>
            <div class="pdf-viewer">
                <iframe src="{pdf_url}" 
                        width="100%" 
                        height="800px" 
                        style="border: 1px solid #ddd; border-radius: 8px;">
                </iframe>
            </div>
            <p class="download-link">
                <a href="{pdf_url}" 
                   download 
                   style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #1e5aa8; color: white; text-decoration: none; border-radius: 5px;">
                   ğŸ“¥ Download PDF
                </a>
            </p>
        </div>
    ''')
    return render_template('index.html', content=content, current_page='dasarhukum')

@app.route('/galery')
def galery():
    content = load_markdown('content_galery.md')
    return render_template('index.html', content=content, current_page='galery')

@app.route('/ikm')
def ikm():
    content = load_markdown('content_ikm.md')
    return render_template('index.html', content=content, current_page='ikm')

@app.route('/ikm/submit', methods=['POST'])
def ikm_submit():
    try:
        data = request.json
        
        persyaratan = int(data.get('persyaratan', 0))
        prosedur = int(data.get('prosedur', 0))
        waktu_pelayanan = int(data.get('waktu_pelayanan', 0))
        biaya_tarif = int(data.get('biaya_tarif', 0))
        produk_layanan = int(data.get('produk_layanan', 0))
        kompetensi_petugas = int(data.get('kompetensi_petugas', 0))
        perilaku_petugas = int(data.get('perilaku_petugas', 0))
        maklumat_pelayanan = int(data.get('maklumat_pelayanan', 0))
        penanganan_pengaduan = int(data.get('penanganan_pengaduan', 0))
        komentar = data.get('komentar', '')
        jenis_layanan = data.get('jenis_layanan', '')
        
        if any(r < 1 or r > 4 for r in [persyaratan, prosedur, waktu_pelayanan, biaya_tarif, 
                                         produk_layanan, kompetensi_petugas, perilaku_petugas, 
                                         maklumat_pelayanan, penanganan_pengaduan]):
            return jsonify({'success': False, 'message': 'Mohon berikan penilaian untuk semua aspek (1-4 bintang)'}), 400
        
        rata_rata = (persyaratan + prosedur + waktu_pelayanan + biaya_tarif + produk_layanan + 
                     kompetensi_petugas + perilaku_petugas + maklumat_pelayanan + penanganan_pengaduan) / 9.0
        
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('''
            INSERT INTO survei_ikm 
            (persyaratan, prosedur, waktu_pelayanan, biaya_tarif, produk_layanan, 
             kompetensi_petugas, perilaku_petugas, maklumat_pelayanan, penanganan_pengaduan, 
             komentar, jenis_layanan, rata_rata)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ''', (persyaratan, prosedur, waktu_pelayanan, biaya_tarif, produk_layanan,
              kompetensi_petugas, perilaku_petugas, maklumat_pelayanan, penanganan_pengaduan,
              komentar, jenis_layanan, rata_rata))
        conn.commit()
        cur.close()
        conn.close()
        
        return jsonify({'success': True, 'message': 'Terima kasih! Penilaian Anda telah berhasil disimpan.'})
    
    except Exception as e:
        print(f"Error: {str(e)}")
        return jsonify({'success': False, 'message': f'Terjadi kesalahan: {str(e)}'}), 500

@app.route('/ikm/hasil')
def ikm_hasil():
    try:
        conn = get_db_connection()
        cur = conn.cursor(cursor_factory=RealDictCursor)
        
        cur.execute('''
            SELECT 
                COUNT(*) as total_responden,
                ROUND(AVG(persyaratan), 2) as avg_persyaratan,
                ROUND(AVG(prosedur), 2) as avg_prosedur,
                ROUND(AVG(waktu_pelayanan), 2) as avg_waktu_pelayanan,
                ROUND(AVG(biaya_tarif), 2) as avg_biaya_tarif,
                ROUND(AVG(produk_layanan), 2) as avg_produk_layanan,
                ROUND(AVG(kompetensi_petugas), 2) as avg_kompetensi_petugas,
                ROUND(AVG(perilaku_petugas), 2) as avg_perilaku_petugas,
                ROUND(AVG(maklumat_pelayanan), 2) as avg_maklumat_pelayanan,
                ROUND(AVG(penanganan_pengaduan), 2) as avg_penanganan_pengaduan,
                ROUND(AVG(rata_rata), 2) as ikm_total
            FROM survei_ikm
        ''')
        stats = cur.fetchone()
        
        cur.execute('''
            SELECT jenis_layanan, COUNT(*) as jumlah
            FROM survei_ikm
            WHERE jenis_layanan IS NOT NULL AND jenis_layanan != ''
            GROUP BY jenis_layanan
            ORDER BY jumlah DESC
        ''')
        layanan_stats = cur.fetchall()
        
        cur.execute('''
            SELECT komentar, created_at, jenis_layanan
            FROM survei_ikm
            WHERE komentar IS NOT NULL AND komentar != ''
            ORDER BY created_at DESC
            LIMIT 10
        ''')
        komentar_list = cur.fetchall()
        
        cur.close()
        conn.close()
        
        if stats['total_responden'] == 0:
            stats = {
                'total_responden': 0,
                'ikm_total': 0,
                'avg_persyaratan': 0,
                'avg_prosedur': 0,
                'avg_waktu_pelayanan': 0,
                'avg_biaya_tarif': 0,
                'avg_produk_layanan': 0,
                'avg_kompetensi_petugas': 0,
                'avg_perilaku_petugas': 0,
                'avg_maklumat_pelayanan': 0,
                'avg_penanganan_pengaduan': 0
            }
        
        ikm_nilai = float(stats['ikm_total']) * 25 if stats['ikm_total'] else 0
        
        if ikm_nilai >= 88.31:
            kategori = "A - Sangat Baik"
            warna = "#10b981"
        elif ikm_nilai >= 76.61:
            kategori = "B - Baik"
            warna = "#3b82f6"
        elif ikm_nilai >= 65.00:
            kategori = "C - Kurang Baik"
            warna = "#f59e0b"
        else:
            kategori = "D - Tidak Baik"
            warna = "#ef4444"
        
        content = Markup(f'''
            <div class="ikm-hasil-container">
                <h1>ğŸ“Š Hasil Indeks Kepuasan Masyarakat</h1>
                <p class="ikm-subtitle">Data survei kepuasan pelayanan SAMSAT Kebumen</p>
                
                <div class="ikm-summary">
                    <div class="ikm-card ikm-card-primary">
                        <div class="ikm-card-icon">ğŸ¯</div>
                        <div class="ikm-card-content">
                            <div class="ikm-card-label">Nilai IKM</div>
                            <div class="ikm-card-value" style="color: {warna};">{ikm_nilai:.2f}</div>
                            <div class="ikm-card-category" style="color: {warna};">{kategori}</div>
                        </div>
                    </div>
                    <div class="ikm-card">
                        <div class="ikm-card-icon">ğŸ‘¥</div>
                        <div class="ikm-card-content">
                            <div class="ikm-card-label">Total Responden</div>
                            <div class="ikm-card-value">{stats['total_responden']}</div>
                        </div>
                    </div>
                    <div class="ikm-card">
                        <div class="ikm-card-icon">â­</div>
                        <div class="ikm-card-content">
                            <div class="ikm-card-label">Rata-rata</div>
                            <div class="ikm-card-value">{stats['ikm_total']:.2f} / 4</div>
                        </div>
                    </div>
                </div>

                <div class="ikm-section">
                    <h2>ğŸ“ˆ Penilaian Per Aspek Pelayanan</h2>
                    <div class="ikm-aspects">
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">1. Persyaratan</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_persyaratan']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_persyaratan']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">2. Prosedur</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_prosedur']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_prosedur']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">3. Waktu Pelayanan</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_waktu_pelayanan']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_waktu_pelayanan']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">4. Biaya/Tarif</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_biaya_tarif']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_biaya_tarif']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">5. Produk Layanan</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_produk_layanan']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_produk_layanan']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">6. Kompetensi Petugas</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_kompetensi_petugas']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_kompetensi_petugas']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">7. Perilaku Petugas</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_perilaku_petugas']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_perilaku_petugas']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">8. Sarana/Prasarana</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_maklumat_pelayanan']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_maklumat_pelayanan']:.2f} / 4</span>
                            </div>
                        </div>
                        <div class="ikm-aspect-item">
                            <div class="ikm-aspect-label">9. Penanganan Pengaduan</div>
                            <div class="ikm-aspect-rating">
                                <div class="ikm-progress-bar">
                                    <div class="ikm-progress-fill" style="width: {(stats['avg_penanganan_pengaduan']/4)*100}%;"></div>
                                </div>
                                <span class="ikm-aspect-value">{stats['avg_penanganan_pengaduan']:.2f} / 4</span>
                            </div>
                        </div>
                    </div>
                </div>

                {f'''
                <div class="ikm-section">
                    <h2>ğŸ“Š Jenis Layanan yang Digunakan</h2>
                    <div class="ikm-layanan-list">
                        {''.join([f'<div class="ikm-layanan-item"><span>{row["jenis_layanan"]}</span><span class="ikm-layanan-count">{row["jumlah"]} responden</span></div>' for row in layanan_stats])}
                    </div>
                </div>
                ''' if layanan_stats else ''}

                {f'''
                <div class="ikm-section">
                    <h2>ğŸ’¬ Komentar & Saran Terbaru</h2>
                    <div class="ikm-comments-list">
                        {''.join([f'<div class="ikm-comment-item"><div class="ikm-comment-text">"{row["komentar"]}"</div><div class="ikm-comment-meta">{row["jenis_layanan"] or "Umum"} â€¢ {row["created_at"].strftime("%d %B %Y")}</div></div>' for row in komentar_list])}
                    </div>
                </div>
                ''' if komentar_list else ''}

                <div class="ikm-back-button">
                    <a href="/ikm" class="btn-back">â† Kembali ke Survei</a>
                </div>
            </div>
        ''')
        
        return render_template('index.html', content=content, current_page='ikm')
    
    except Exception as e:
        print(f"Error: {str(e)}")
        content = Markup(f'<div class="error-message"><h2>Terjadi Kesalahan</h2><p>{str(e)}</p><a href="/ikm">Kembali ke Survei</a></div>')
        return render_template('index.html', content=content, current_page='ikm')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
